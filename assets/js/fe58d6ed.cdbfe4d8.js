"use strict";(self.webpackChunkplu_ts_docs=self.webpackChunkplu_ts_docs||[]).push([[5309],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var i=a.createContext({}),u=function(e){var t=a.useContext(i),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(i.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,i=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=u(n),h=o,m=d["".concat(i,".").concat(h)]||d[h]||p[h]||r;return n?a.createElement(m,l(l({ref:t},c),{},{components:n})):a.createElement(m,l({ref:t},c))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,l=new Array(r);l[0]=h;var s={};for(var i in t)hasOwnProperty.call(t,i)&&(s[i]=t[i]);s.originalType=e,s[d]="string"==typeof e?e:o,l[1]=s;for(var u=2;u<r;u++)l[u]=n[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},5162:(e,t,n)=>{n.d(t,{Z:()=>l});var a=n(7294),o=n(6010);const r={tabItem:"tabItem_Ymn6"};function l(e){let{children:t,hidden:n,className:l}=e;return a.createElement("div",{role:"tabpanel",className:(0,o.Z)(r.tabItem,l),hidden:n},t)}},4866:(e,t,n)=>{n.d(t,{Z:()=>b});var a=n(7462),o=n(7294),r=n(6010),l=n(2466),s=n(6550),i=n(1980),u=n(7392),c=n(12);function d(e){return function(e){return o.Children.map(e,(e=>{if((0,o.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))}(e).map((e=>{let{props:{value:t,label:n,attributes:a,default:o}}=e;return{value:t,label:n,attributes:a,default:o}}))}function p(e){const{values:t,children:n}=e;return(0,o.useMemo)((()=>{const e=t??d(n);return function(e){const t=(0,u.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function h(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function m(e){let{queryString:t=!1,groupId:n}=e;const a=(0,s.k6)(),r=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,i._X)(r),(0,o.useCallback)((e=>{if(!r)return;const t=new URLSearchParams(a.location.search);t.set(r,e),a.replace({...a.location,search:t.toString()})}),[r,a])]}function k(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,r=p(e),[l,s]=(0,o.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!h({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:t,tabValues:r}))),[i,u]=m({queryString:n,groupId:a}),[d,k]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[a,r]=(0,c.Nk)(n);return[a,(0,o.useCallback)((e=>{n&&r.set(e)}),[n,r])]}({groupId:a}),f=(()=>{const e=i??d;return h({value:e,tabValues:r})?e:null})();(0,o.useLayoutEffect)((()=>{f&&s(f)}),[f]);return{selectedValue:l,selectValue:(0,o.useCallback)((e=>{if(!h({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);s(e),u(e),k(e)}),[u,k,r]),tabValues:r}}var f=n(2389);const g={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function w(e){let{className:t,block:n,selectedValue:s,selectValue:i,tabValues:u}=e;const c=[],{blockElementScrollPositionUntilNextRender:d}=(0,l.o5)(),p=e=>{const t=e.currentTarget,n=c.indexOf(t),a=u[n].value;a!==s&&(d(t),i(a))},h=e=>{let t=null;switch(e.key){case"Enter":p(e);break;case"ArrowRight":{const n=c.indexOf(e.currentTarget)+1;t=c[n]??c[0];break}case"ArrowLeft":{const n=c.indexOf(e.currentTarget)-1;t=c[n]??c[c.length-1];break}}t?.focus()};return o.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":n},t)},u.map((e=>{let{value:t,label:n,attributes:l}=e;return o.createElement("li",(0,a.Z)({role:"tab",tabIndex:s===t?0:-1,"aria-selected":s===t,key:t,ref:e=>c.push(e),onKeyDown:h,onClick:p},l,{className:(0,r.Z)("tabs__item",g.tabItem,l?.className,{"tabs__item--active":s===t})}),n??t)})))}function y(e){let{lazy:t,children:n,selectedValue:a}=e;if(n=Array.isArray(n)?n:[n],t){const e=n.find((e=>e.props.value===a));return e?(0,o.cloneElement)(e,{className:"margin-top--md"}):null}return o.createElement("div",{className:"margin-top--md"},n.map(((e,t)=>(0,o.cloneElement)(e,{key:t,hidden:e.props.value!==a}))))}function x(e){const t=k(e);return o.createElement("div",{className:(0,r.Z)("tabs-container",g.tabList)},o.createElement(w,(0,a.Z)({},e,t)),o.createElement(y,(0,a.Z)({},e,t)))}function b(e){const t=(0,f.Z)();return o.createElement(x,(0,a.Z)({key:String(t)},e))}},2166:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>u});var a=n(7462),o=(n(7294),n(3905));n(4866),n(5162);const r={sidebar_position:0},l="Hello plu-ts",s={unversionedId:"examples/Hello World",id:"examples/Hello World",title:"Hello plu-ts",description:"In this example prject we'll write our first smart contract and interact with it using the CIP-0030 standard.",source:"@site/docs/examples/Hello World.mdx",sourceDirName:"examples",slug:"/examples/Hello World",permalink:"/docs/examples/Hello World",draft:!1,editUrl:"https://github.com/HarmonicLabs/plu-ts/tree/main/packages/create-docusaurus/templates/shared/docs/examples/Hello World.mdx",tags:[],version:"current",sidebarPosition:0,frontMatter:{sidebar_position:0},sidebar:"tutorialSidebar",previous:{title:"Examples",permalink:"/docs/category/examples"},next:{title:"Vesting",permalink:"/docs/examples/Vesting"}},i={},u=[{value:"Pre-requisites",id:"pre-requisites",level:2},{value:"Project set up",id:"project-set-up",level:2},{value:"Project overview",id:"project-overview",level:3},{value:"The contract",id:"the-contract",level:2},{value:"introduce an <code>owner</code>",id:"introduce-an-owner",level:3},{value:"send messages to the contracts",id:"send-messages-to-the-contracts",level:3},{value:"implement the logic",id:"implement-the-logic",level:3},{value:"Lock some funds",id:"lock-some-funds",level:2},{value:"<code>myAddr</code>",id:"myaddr",level:3},{value:"<code>txBuilder</code>",id:"txbuilder",level:3},{value:"<code>myUTxOs</code>",id:"myutxos",level:3},{value:"<code>utxo</code>",id:"utxo",level:3},{value:"build and return the transaciton",id:"build-and-return-the-transaciton",level:3},{value:"test it out",id:"test-it-out",level:3},{value:"Unlock the funds",id:"unlock-the-funds",level:2},{value:"<code>txBuilder</code> and <code>myUTxOs</code>",id:"txbuilder-and-myutxos",level:3},{value:"<code>myAddrs</code> and <code>myAddr</code>",id:"myaddrs-and-myaddr",level:3},{value:"get the script&#39;s utxos",id:"get-the-scripts-utxos",level:3},{value:"build the transaciton",id:"build-the-transaciton",level:3},{value:"test the contract",id:"test-the-contract",level:3}],c={toc:u},d="wrapper";function p(e){let{components:t,...r}=e;return(0,o.kt)(d,(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"hello-plu-ts"},"Hello plu-ts"),(0,o.kt)("p",null,"In this example prject we'll write our first smart contract and interact with it using the ",(0,o.kt)("a",{parentName:"p",href:"https://cips.cardano.org/cips/cip30/"},"CIP-0030")," standard."),(0,o.kt)("p",null,"The final verision of this project is aviable ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/michele-nuzzi/hello-pluts-react-final"},"here")," and you can test it out in the ",(0,o.kt)("a",{parentName:"p",href:"https://hello-pluts.harmoniclabs.tech/"},"live demo"),"."),(0,o.kt)("h2",{id:"pre-requisites"},"Pre-requisites"),(0,o.kt)("p",null,"All we need to build a dApp is:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"plu-ts")),(0,o.kt)("li",{parentName:"ul"},"some way to submit transactions."),(0,o.kt)("li",{parentName:"ul"},"react + ",(0,o.kt)("a",{parentName:"li",href:"https://meshjs.dev/"},(0,o.kt)("inlineCode",{parentName:"a"},"MeshSDK")))),(0,o.kt)("p",null,"Infact, ",(0,o.kt)("inlineCode",{parentName:"p"},"plu-ts")," allows you to write the smart contract and create transactions."),(0,o.kt)("p",null,"To submit the tranasction we will use ",(0,o.kt)("a",{parentName:"p",href:"../tools/koios-pluts"},(0,o.kt)("inlineCode",{parentName:"a"},"koios-pluts")),", a wrapper on top of the ",(0,o.kt)("a",{parentName:"p",href:"https://www.koios.rest/"},"koios")," API that uses ",(0,o.kt)("inlineCode",{parentName:"p"},"plu-ts")," offchain types;\nbut we'll think about that later."),(0,o.kt)("p",null,"So for now our pre-requisites add up to:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"plu-ts")," (and ",(0,o.kt)("inlineCode",{parentName:"li"},"npm")," to install it)"),(0,o.kt)("li",{parentName:"ul"},"anything that can run javascript (server environment or browser, doesn't matter)"),(0,o.kt)("li",{parentName:"ul"},"an internet connection")),(0,o.kt)("h2",{id:"project-set-up"},"Project set up"),(0,o.kt)("p",null,"using ",(0,o.kt)("inlineCode",{parentName:"p"},"git")," we clone the initial ",(0,o.kt)("inlineCode",{parentName:"p"},"hello-pluts-react")," project form ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/HarmonicLabs/hello-pluts-react"},"github"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/HarmonicLabs/hello-pluts-react.git\ncd hello-pluts-react\ngit remote remove origin\n")),(0,o.kt)("p",null,"this gives us the following project structure:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"./hello-pluts-react\n\u251c\u2500\u2500 contracts\n\u2502   \u2514\u2500\u2500 helloPluts.ts\n\u251c\u2500\u2500 next.config.js\n\u251c\u2500\u2500 next-env.d.ts\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 package-lock.json\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 src\n\u2502   \u251c\u2500\u2500 components\n\u2502   \u2502   \u2514\u2500\u2500 ConnectionHandler.tsx\n\u2502   \u251c\u2500\u2500 offchain\n\u2502   \u2502   \u251c\u2500\u2500 getTxBuilder.ts\n\u2502   \u2502   \u251c\u2500\u2500 koios.ts\n\u2502   \u2502   \u251c\u2500\u2500 lockTx.ts\n\u2502   \u2502   \u251c\u2500\u2500 mesh-utils.ts\n\u2502   \u2502   \u2514\u2500\u2500 unlockTx.ts\n\u2502   \u251c\u2500\u2500 pages\n\u2502   \u2502   \u251c\u2500\u2500 _app.tsx\n\u2502   \u2502   \u251c\u2500\u2500 _document.tsx\n\u2502   \u2502   \u2514\u2500\u2500 index.tsx\n\u2502   \u2514\u2500\u2500 styles\n\u2502       \u251c\u2500\u2500 globals.css\n\u2502       \u2514\u2500\u2500 Home.module.css\n\u2514\u2500\u2500 tsconfig.json\n")),(0,o.kt)("p",null,"The project comes with all the dependencies we need;"),(0,o.kt)("p",null,"The most important ones are:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="package.json"',title:'"package.json"'},'"dependencies": {\n    "@harmoniclabs/plu-ts": "^0.3.0",\n    "@harmoniclabs/koios-pluts": "^0.1.3",\n    "@harmoniclabs/uint8array-utils": "^1.0.0",\n    "@meshsdk/core": "^1.5.2",\n    "@meshsdk/react": "^1.1.7",\n    /* other deps */\n}\n')),(0,o.kt)("p",null,"So now we only need to run ",(0,o.kt)("inlineCode",{parentName:"p"},"npm install")," to automatically add them."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"npm install\n")),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"et voil\xe0")," we are ready to start!"),(0,o.kt)("h3",{id:"project-overview"},"Project overview"),(0,o.kt)("p",null,"From the project structure we see that the code can be fund in the ",(0,o.kt)("inlineCode",{parentName:"p"},"src")," folder and the  ",(0,o.kt)("inlineCode",{parentName:"p"},"contracts")," folder."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"contracts")," only file is the ",(0,o.kt)("inlineCode",{parentName:"p"},"helloPluts.ts")," one; which for now contains only a contract that always fails and exports the compiled result."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="contracts/helloPluts.ts"',title:'"contracts/helloPluts.ts"'},'import { Address, PScriptContext, PaymentCredentials, Script, bool, compile, data, makeValidator, pBool, pfn } from "@harmoniclabs/plu-ts";\n\n\nconst helloPluts = pfn([\n    data,\n    data,\n    PScriptContext.type\n], bool)\n(( datum, redeemer, ctx ) => {\n\n    // locks funds forever\n    return pBool( false );\n});\n\n///////////////////////////////////////////////////////////////////\n// ------------------------------------------------------------- //\n// ------------------------- utilities ------------------------- //\n// ------------------------------------------------------------- //\n///////////////////////////////////////////////////////////////////\n\nexport const untypedValidator = makeValidator( helloPluts );\n\nexport const compiledContract = compile( untypedValidator );\n\nexport const script = new Script(\n    "PlutusScriptV2",\n    compiledContract\n);\n\nexport const scriptTestnetAddr = new Address(\n    "testnet",\n    PaymentCredentials.script( script.hash )\n);\n')),(0,o.kt)("p",null,"We'll come back on this file later."),(0,o.kt)("p",null,"The other two files we'll work with are ",(0,o.kt)("inlineCode",{parentName:"p"},"src/offchain/lockTx.ts")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"src/offchain/unlockTx.ts"),"."),(0,o.kt)("p",null,"Both very similar."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/offchain/lockTx.ts"',title:'"src/offchain/lockTx.ts"'},'import { Tx } from "@harmoniclabs/plu-ts";\nimport { BrowserWallet } from "@meshsdk/core";\nimport koios from "./koios";\n\nasync function getLockTx( wallet: BrowserWallet ): Promise<Tx>\n{\n    throw "\'lockTx\' logic not implemented";\n}\n\nexport async function lockTx( wallet: BrowserWallet): Promise<string>\n{\n    const unsingedTx = await getLockTx( wallet );\n\n    const txStr = await wallet.signTx(\n        unsingedTx.toCbor().toString()\n    );\n\n    return (await koios.tx.submit( Tx.fromCbor( txStr ) as any )).toString();\n}\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/offchain/unlockTx.ts"',title:'"src/offchain/unlockTx.ts"'},'import { Tx } from "@harmoniclabs/plu-ts";\nimport { BrowserWallet } from "@meshsdk/core";\nimport { koios } from "./koios";\n\nasync function getUnlockTx( wallet: BrowserWallet ): Promise<Tx>\n{\n    throw "\'unlockTx\' logic not implemented";   \n}\n\nexport async function unlockTx( wallet: BrowserWallet ): Promise<string>\n{\n    const unsingedTx = await getUnlockTx( wallet );\n\n    const txStr = await wallet.signTx(\n        unsingedTx.toCbor().toString(),\n        true // partial sign because we have smart contracts in the transaction\n    );\n\n    return (await koios.tx.submit( Tx.fromCbor( txStr ) )).toString();\n}\n')),(0,o.kt)("p",null,"Our work later in this project will be to create the transactions that will interact with the contract."),(0,o.kt)("p",null,"This will be done using the plu-ts ",(0,o.kt)("a",{parentName:"p",href:"../offchain/TxBuilder%20API/TxBuilder"},(0,o.kt)("inlineCode",{parentName:"a"},"TxBuilder")),"."),(0,o.kt)("p",null,"The code to get a ",(0,o.kt)("inlineCode",{parentName:"p"},"TxBuilder")," instance is already defined in the ",(0,o.kt)("inlineCode",{parentName:"p"},"src/offchain/getTxBuilder.ts")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/offchain/getTxBuilder.ts"',title:'"src/offchain/getTxBuilder.ts"'},'import { ProtocolParamters, TxBuilder, defaultProtocolParameters } from "@harmoniclabs/plu-ts";\nimport { koios } from "./koios"\n\n/**\n * we don\'t want to do too many API call if we already have our `txBuilder`\n * \n * so after the first call we\'ll store a copy here.\n**/\nlet _cachedTxBuilder: TxBuilder | undefined = undefined\n\nexport default async function getTxBuilder(): Promise<TxBuilder>\n{\n    if(!( _cachedTxBuilder instanceof TxBuilder ))\n    {\n        try {\n            const pp = await koios.epoch.protocolParams() as Readonly<ProtocolParamters>;\n\n            _cachedTxBuilder = new TxBuilder(\n                "testnet",\n                pp\n            );\n        }\n        catch { // just in kase koios returns protocol paramters that don\'t look good\n            // if that happens then use the default protocol paramters\n            // !!! IMPORTANT !!! use only as fallback;\n            // parameters might (and will) change from the real world\n            _cachedTxBuilder = new TxBuilder(\n                "testnet",\n                defaultProtocolParameters\n            );\n        }\n    }\n\n    return _cachedTxBuilder;\n}\n')),(0,o.kt)("p",null,"constructing a ",(0,o.kt)("inlineCode",{parentName:"p"},"TxBuilder")," requires us to pass the protocol paramters of the chain we are operating in."),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("mdxAdmonitionTitle",{parentName:"admonition"},"why the ",(0,o.kt)("inlineCode",{parentName:"mdxAdmonitionTitle"},"try{ ... }catch{ ... }")," here?"),(0,o.kt)("p",{parentName:"admonition"},"If the protocol parameters passed are not correct (for any reason); the TxBuilder constructor throws."),(0,o.kt)("p",{parentName:"admonition"},"In that case we can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"defaultProtocolParameters")," exported by ",(0,o.kt)("inlineCode",{parentName:"p"},"plu-ts"),", which are always valid."),(0,o.kt)("p",{parentName:"admonition"},"However (as the comment above explains) these paramters might not reflect reality so should be used with caution.")),(0,o.kt)("p",null,"To get the protocol prameters we are using a ",(0,o.kt)("inlineCode",{parentName:"p"},"koios")," object; this is exported from the ",(0,o.kt)("inlineCode",{parentName:"p"},"src/offchain/koios.ts")," file"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/offchain/koios.ts"',title:'"src/offchain/koios.ts"'},'import { KoiosProvider } from "@harmoniclabs/koios-pluts"\n\nexport const koios = new KoiosProvider("preprod");\n\nexport default koios;\n')),(0,o.kt)("p",null,"the file is really simple, and this is because we are using the ",(0,o.kt)("a",{parentName:"p",href:"../tools/koios-pluts"},(0,o.kt)("inlineCode",{parentName:"a"},"koios-pluts"))," package."),(0,o.kt)("p",null,"Here we construct a ",(0,o.kt)("inlineCode",{parentName:"p"},"KoiosProvider")," insatance that will do the koios REST API calls for us."),(0,o.kt)("p",null,"Then there is the website."),(0,o.kt)("p",null,"This is a very simple ",(0,o.kt)("a",{parentName:"p",href:"https://nextjs.org/"},"Next.js")," project. of which the only page is in ",(0,o.kt)("inlineCode",{parentName:"p"},"src/pages/index.tsx")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="src/pages/index.tsx"',title:'"src/pages/index.tsx"'},'import { Button, useToast } from "@chakra-ui/react";\nimport { useNetwork, useWallet } from "@meshsdk/react";\n\nimport style from "@/styles/Home.module.css";\nimport ConnectionHandler from "@/components/ConnectionHandler";\nimport { lockTx } from "@/offchain/lockTx";\nimport { unlockTx } from "@/offchain/unlockTx";\n\nexport default function Home()\n{\n    const { wallet, connected } = useWallet();\n    const network = useNetwork();\n    const toast = useToast();\n\n    if( typeof network === "number" && network !== 0 )\n    {\n        return (\n            <div className={[\n                style.pageContainer,\n                "center-child-flex-even"\n            ].join(" ")}\n            >\n                <b style={{\n                    margin: "auto 10vw"\n                }}>\n                    Make sure to set your wallet in testnet mode;<br/>\n                    We are playing with funds here!\n                </b>\n                <Button\n                onClick={() => window.location.reload()}\n                style={{\n                    margin: "auto 10vw"\n                }}\n                >Refersh page</Button>\n            </div>\n        )\n    }\n\n    function onLock()\n    {\n        lockTx( wallet )\n        // lock transaction created successfully\n        .then( txHash => toast({\n            title: `lock tx submitted: https://preprod.cardanoscan.io/transaction/${txHash}`,\n            status: "success"\n        }))\n        // lock transaction failed\n        .catch( e => {\n            toast({\n                title: `something went wrong`,\n                status: "error"\n            });\n            console.error( e )\n        });\n    }\n\n    function onUnlock()\n    {\n        unlockTx( wallet )\n        // unlock transaction created successfully\n        .then( txHash => toast({\n            title: `unlock tx submitted: https://preprod.cardanoscan.io/transaction/${txHash}`,\n            status: "success"\n        }))\n        // unlock transaction failed\n        .catch( e => {\n            toast({\n                title: `something went wrong`,\n                status: "error"\n            });\n            console.error( e )\n        });\n    }\n\n    return (\n        <div className={[\n            style.pageContainer,\n            "center-child-flex-even"\n        ].join(" ")} >\n            <ConnectionHandler />\n            {\n                connected &&\n                <>\n                <Button onClick={onLock} >Lock 10 tADA</Button>\n                <Button onClick={onUnlock} >Unlock</Button>\n                </>\n            }\n        </div>\n    )\n}\n')),(0,o.kt)("p",null,"all the logic of the user interface (UI) is happening here."),(0,o.kt)("p",null,"we are using the ",(0,o.kt)("inlineCode",{parentName:"p"},"useNetwork")," react hook imported from ",(0,o.kt)("a",{parentName:"p",href:"https://meshjs.dev/react/wallet-hooks"},(0,o.kt)("inlineCode",{parentName:"a"},"@meshsdk/react")),"\njust to prevent users to play with the contract in mainnet."),(0,o.kt)("p",null,"but the cool part is the ",(0,o.kt)("inlineCode",{parentName:"p"},"useWallet")," hook that gives us access to the user's wallet once connected."),(0,o.kt)("p",null,"the connection happens in the ",(0,o.kt)("inlineCode",{parentName:"p"},"ConnectionHandler")," component we defined in ",(0,o.kt)("inlineCode",{parentName:"p"},"src/components/ConnectionHandler.ts"),".\nYou can check it yourself if you want to see how easy the connection process becomes with ",(0,o.kt)("a",{parentName:"p",href:"https://meshjs.dev/react/wallet-hooks"},(0,o.kt)("inlineCode",{parentName:"a"},"@meshsdk/react"))),(0,o.kt)("p",null,"And with that this is it."),(0,o.kt)("p",null,"You can try this web applicaiton running"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"npm run dev\n")),(0,o.kt)("p",null,"this will output somehting like the following"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"\n> hello-pluts-react@0.1.0 dev\n> next dev\n\nready - started server on 0.0.0.0:3000, url: http://localhost:3000\n")),(0,o.kt)("p",null,"the numbers may vary a little but that is not a problem."),(0,o.kt)("p",null,"you can check out the website going to the specified url; in the example above is ",(0,o.kt)("inlineCode",{parentName:"p"},"http://localhost:3000"),"."),(0,o.kt)("p",null,"However at this very moment the app won't do much."),(0,o.kt)("p",null,"So let's start by defining what the contract should do."),(0,o.kt)("h2",{id:"the-contract"},"The contract"),(0,o.kt)("p",null,"We want to personalize the smart contract so that:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"it suceeds if the transaction is signed by us."),(0,o.kt)("li",{parentName:"ul"},"and we are being polite by saluting the contract.")),(0,o.kt)("h3",{id:"introduce-an-owner"},"introduce an ",(0,o.kt)("inlineCode",{parentName:"h3"},"owner")),(0,o.kt)("p",null,"To make sure the transaction is signed by us we'll keep track of an ",(0,o.kt)("inlineCode",{parentName:"p"},"owner")," in the datum (the first argument we saw in the contract)."),(0,o.kt)("admonition",{title:"datum",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"The datum helps us keep track of the history of the input the smart contract is validating.")),(0,o.kt)("p",null,"Currently our datum is a generic ",(0,o.kt)("inlineCode",{parentName:"p"},"data")," argument, but it could be really anything;"),(0,o.kt)("p",null,"in our case all we need to keep track of is an owner"),(0,o.kt)("p",null,"an that can be identified using a public key hash."),(0,o.kt)("p",null,"so in ",(0,o.kt)("inlineCode",{parentName:"p"},"src/contract.ts")," we'll change the first ",(0,o.kt)("inlineCode",{parentName:"p"},"data")," to ",(0,o.kt)("a",{parentName:"p",href:"../onchain/API/types/PPubKeyHash"},(0,o.kt)("inlineCode",{parentName:"a"},"PPubKeyHash"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/contract.ts"',title:'"src/contract.ts"'},"/* imports */\n\nconst helloPluts = pfn([\n    // highlight-next-line\n    PPubKeyHash.type,\n    data,\n    PScriptContext.type\n], bool)\n// highlight-next-line\n//  datum -> owner\n// highlight-next-line\n(( owner, redeemer, ctx ) => {\n\n    // locks funds forever\n    return pBool( false );\n});\n\n/* ... */\n")),(0,o.kt)("h3",{id:"send-messages-to-the-contracts"},"send messages to the contracts"),(0,o.kt)("p",null,"The second condtion requires us to send some message to the contract."),(0,o.kt)("p",null,"This is done thanks to the redeemer (or the second argument of a validator)."),(0,o.kt)("admonition",{title:"redeemer",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"The redeemer is the argument specified by the user that interacts with the smart contract")),(0,o.kt)("p",null,"once again, all we need in order to have a message is just a ",(0,o.kt)("inlineCode",{parentName:"p"},"bytestring"),", nothing more complex,"),(0,o.kt)("p",null,"so we'll change the second ",(0,o.kt)("inlineCode",{parentName:"p"},"data")," to the primitive type ",(0,o.kt)("inlineCode",{parentName:"p"},"bs"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/contract.ts"',title:'"src/contract.ts"'},"/* imports */\n\nconst helloPluts = pfn([\n    PPubKeyHash.type,\n    // highlight-next-line\n    bs,\n    PScriptContext.type\n], bool)\n// highlight-next-line\n//  redeemer -> message\n// highlight-next-line\n(( owner, message, ctx ) => {\n\n    // locks funds forever\n    return pBool( false );\n});\n\n/* ... */\n")),(0,o.kt)("h3",{id:"implement-the-logic"},"implement the logic"),(0,o.kt)("p",null,"finally we'll check both the conditions in the body of the function."),(0,o.kt)("p",null,"so we'll first create a term that checks that the message is the one expected:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'const isBeingPolite = message.eq("Hello plu-ts");\n')),(0,o.kt)("p",null,"then we'll check that the transaction is signed by the owner specified in the datum."),(0,o.kt)("p",null,"to do so we need informations about the tranasaction and who signed it."),(0,o.kt)("p",null,"all the informations about the tranasaction are in the ",(0,o.kt)("inlineCode",{parentName:"p"},"tx")," field of the ",(0,o.kt)("a",{parentName:"p",href:"../onchain/API/types/PScriptContex"},(0,o.kt)("inlineCode",{parentName:"a"},"PScriptContex"))),(0,o.kt)("p",null,"an in particular we are interested in the ",(0,o.kt)("a",{parentName:"p",href:"../onchain/API/types/PTxInfo#signatories"},(0,o.kt)("inlineCode",{parentName:"a"},"signatories")," field")," "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"ctx.tx.signatories;\n")),(0,o.kt)("p",null,"since this is a list of all the required singers we chan use all the ",(0,o.kt)("a",{parentName:"p",href:"../onchain/stdlib/TermList"},(0,o.kt)("inlineCode",{parentName:"a"},"TermList"))," methods;\nof which ",(0,o.kt)("a",{parentName:"p",href:"../onchain/stdlib/TermList#some"},(0,o.kt)("inlineCode",{parentName:"a"},"some"))," allows us to check that ",(0,o.kt)("strong",{parentName:"p"},"at leat one")," element of the list respects a given property:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const signedByOwner = ctx.tx.signatories.some( owner.eqTerm );\n")),(0,o.kt)("p",null,"and finally, we put all together"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/contract.ts"',title:'"src/contract.ts"'},'import { Address, PPubKeyHash, PScriptContext, PaymentCredentials, Script, bool, bs, compile, makeValidator, pfn } from "@harmoniclabs/plu-ts";\n\nconst helloPluts = pfn([\n    PPubKeyHash.type,\n    bs,\n    PScriptContext.type\n],  bool)\n(( owner, message, ctx ) => {\n\n    // highlight-start\n    const isBeingPolite = message.eq("Hello plu-ts");\n\n    const signedByOwner = ctx.tx.signatories.some( owner.eqTerm );\n\n    return isBeingPolite.and( signedByOwner );\n    // highlight-end\n});\n\n/* ... */\n')),(0,o.kt)("p",null,"And this is it! this is our contract."),(0,o.kt)("p",null,"To test it however we need to create transactions with it..."),(0,o.kt)("h2",{id:"lock-some-funds"},"Lock some funds"),(0,o.kt)("p",null,"In order for the smart contract to run it first needs something to spend;\nso now we will build a transaciton that sends some funds to the contract\nand provides the datum that will be used when the funds we are sending are spent."),(0,o.kt)("admonition",{title:"datum",type:"info"},(0,o.kt)("p",{parentName:"admonition"},"As said before the datum acts as the contract local memory."),(0,o.kt)("p",{parentName:"admonition"},"for this reason we must set it now that we are funding the contract;\nas such; the datum is not provided in the spending transaction\n(or if it is it has to match the one that was setted in the transaction before;\notherwise the transaciton is invalid)")),(0,o.kt)("p",null,"so far what we have is this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/offchain/lockTx.ts"',title:'"src/offchain/lockTx.ts"'},"async function getLockTx( wallet: BrowserWallet ): Promise<Tx>\n{\n    throw \"'lockTx' logic not implemented\";\n}\n")),(0,o.kt)("h3",{id:"myaddr"},(0,o.kt)("inlineCode",{parentName:"h3"},"myAddr")),(0,o.kt)("p",null,"The function takes as input the wallet with which the user is connected."),(0,o.kt)("p",null,"the first thing we can do with the wallet is to request the user address"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"await wallet.getChangeAddress()\n")),(0,o.kt)("p",null,"that expresions returns a string which is a cardano address in bech32 format (",(0,o.kt)("inlineCode",{parentName:"p"},'"addr_test1v..."'),")"),(0,o.kt)("p",null,"a string isn't really that useful, so we'll use that to build a plu-ts ",(0,o.kt)("inlineCode",{parentName:"p"},"Address")," instance:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const myAddr = Address.fromString(\n    await wallet.getChangeAddress()\n);\n")),(0,o.kt)("h3",{id:"txbuilder"},(0,o.kt)("inlineCode",{parentName:"h3"},"txBuilder")),(0,o.kt)("p",null,"Since we want to build a transaciton here it might be a good idea to have a ",(0,o.kt)("inlineCode",{parentName:"p"},"TxBuilder")," instance to help us."),(0,o.kt)("p",null,"We already have the code to create one in the ",(0,o.kt)("inlineCode",{parentName:"p"},"src/offchain/getTxBuilder.ts")," file; so we just need to import it and call the function"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const txBuilder = await getTxBuilder();\n")),(0,o.kt)("h3",{id:"myutxos"},(0,o.kt)("inlineCode",{parentName:"h3"},"myUTxOs")),(0,o.kt)("p",null,"A transaction expects as input some output of a previous tranasaction that hasnt been spent yet;"),(0,o.kt)("p",null,"people call this stuff UTxO (",(0,o.kt)("strong",{parentName:"p"},"U"),"nspent ",(0,o.kt)("strong",{parentName:"p"},"T"),"ransa",(0,o.kt)("em",{parentName:"p"},"ct"),"ion ",(0,o.kt)("strong",{parentName:"p"},"O"),"utput)."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"BrowserWallet")," turns ourselves useful once again here; we can get the wallet utxos calling"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"await wallet.getUtxos();\n")),(0,o.kt)("p",null,"However, since this is a function defined by ",(0,o.kt)("inlineCode",{parentName:"p"},"mesh"),"; it is not of the type that the plu-ts ",(0,o.kt)("inlineCode",{parentName:"p"},"TxBuilder")," expects."),(0,o.kt)("p",null,"For this reason we can ",(0,o.kt)("inlineCode",{parentName:"p"},"map")," ",(0,o.kt)("inlineCode",{parentName:"p"},"toPlutsUtxo")," (defined in ",(0,o.kt)("inlineCode",{parentName:"p"},"src/offchain/mesh-utils.ts"),") over the result of the ",(0,o.kt)("inlineCode",{parentName:"p"},"getUtxos")," call;\nso that ",(0,o.kt)("inlineCode",{parentName:"p"},"myUTxOs")," is defined as:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'myUTxOs = (await wallet.getUtxos()).map( toPlutsUtxo );\n\nif( myUTxOs.length === 0 )\n{\n    throw new Error("have you requested funds from the faucet?")\n}\n')),(0,o.kt)("admonition",{title:"get some funds",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"if ",(0,o.kt)("inlineCode",{parentName:"p"},"myUTxOs")," happens to be empty (",(0,o.kt)("inlineCode",{parentName:"p"},"length === 0"),") that means that your wallet has nothing in it."),(0,o.kt)("p",{parentName:"admonition"},"If that is the case you can use the ",(0,o.kt)("a",{parentName:"p",href:"https://docs.cardano.org/cardano-testnet/tools/faucet"},"Cardano Testnet Faucet")," to get some testnet funds."),(0,o.kt)("p",{parentName:"admonition"},"Just be sure to select the ",(0,o.kt)("strong",{parentName:"p"},"Preprod")," testnet.")),(0,o.kt)("admonition",{title:"return the test ADA",type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"once you finish with your tADA make sure to return them to the faucet."),(0,o.kt)("p",{parentName:"admonition"},"tADA have no real world value but are still limited, and onther developers will need them!"),(0,o.kt)("p",{parentName:"admonition"},"to return tADA to the faucet just send them to the following testnet address:"),(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"addr_test1qqr585tvlc7ylnqvz8pyqwauzrdu0mxag3m7q56grgmgu7sxu2hyfhlkwuxupa9d5085eunq2qywy7hvmvej456flknswgndm3"))),(0,o.kt)("h3",{id:"utxo"},(0,o.kt)("inlineCode",{parentName:"h3"},"utxo")),(0,o.kt)("p",null,"With this transaciton we want to send 10 ADA to the contract."),(0,o.kt)("p",null,"so we search between the utxos we already have for one that has a little more than that (so that we can cover the tranasaction fees)."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'const utxo = myUTxOs.find( u => u.resolved.value.lovelaces > 15_000_000 );\n\nif( utxo === undefined )\n{\n    throw "not enough ada";\n}\n')),(0,o.kt)("h3",{id:"build-and-return-the-transaciton"},"build and return the transaciton"),(0,o.kt)("p",null,"and with all this we have:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"an user utxo to use as input"),(0,o.kt)("li",{parentName:"ul"},"the ",(0,o.kt)("inlineCode",{parentName:"li"},"scriptTestnetAddr")," (imported from ",(0,o.kt)("inlineCode",{parentName:"li"},"contracts/helloPluts.ts"),") which is the script address to use in the output"),(0,o.kt)("li",{parentName:"ul"},"the user public key hash that we'll use as output datum")),(0,o.kt)("p",null,"Which is all we need for our transaciton;"),(0,o.kt)("p",null,"so we can build it using the ",(0,o.kt)("inlineCode",{parentName:"p"},"txBuilder")," we have:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"txBuilder.buildSync({\n    inputs: [{ utxo }],\n    outputs: [\n        { // output holding the funds that we'll spend later\n            address: scriptTestnetAddr,\n            // 10M lovelaces === 10 ADA\n            value: Value.lovelaces( 10_000_000 ),\n            // remeber to include a datum\n            datum: new DataB(\n                // remember we set the datum to be the public key hash?\n                // we can extract it from the address as follows\n                myAddr.paymentCreds.hash.toBuffer()\n            )\n        }\n    ],\n    // send everything left back to us\n    changeAddress: myAddr\n});\n")),(0,o.kt)("p",null,"so that the final ",(0,o.kt)("inlineCode",{parentName:"p"},"getLockTx")," function should look like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/offchain/lockTx.ts"',title:'"src/offchain/lockTx.ts"'},'async function getLockTx( wallet: BrowserWallet ): Promise<Tx>\n{\n    // creates an address form the bech32 form\n    const myAddr = Address.fromString(\n        await wallet.getChangeAddress()\n    );\n\n    const txBuilder = await getTxBuilder();\n    const myUTxOs = (await wallet.getUtxos()).map( toPlutsUtxo );\n\n    if( myUTxOs.length === 0 )\n    {\n        throw new Error("have you requested funds from the faucet?")\n    }\n\n    const utxo = myUTxOs.find( u => u.resolved.value.lovelaces > 15_000_000 );\n\n    if( utxo === undefined )\n    {\n        throw "not enough ada";\n    }\n\n    return txBuilder.buildSync({\n        inputs: [{ utxo }],\n        outputs: [\n            { // output holding the funds that we\'ll spend later\n                address: scriptTestnetAddr,\n                // 10M lovelaces === 10 ADA\n                value: Value.lovelaces( 10_000_000 ),\n                // remeber to include a datum\n                datum: new DataB(\n                    // remember we set the datum to be the public key hash?\n                    // we can extract it from the address as follows\n                    myAddr.paymentCreds.hash.toBuffer()\n                )\n            }\n        ],\n        // send everything left back to us\n        changeAddress: myAddr\n    });\n}\n')),(0,o.kt)("h3",{id:"test-it-out"},"test it out"),(0,o.kt)("p",null,"with ",(0,o.kt)("inlineCode",{parentName:"p"},"getLockTx")," implemented the first button on the webpage should now work."),(0,o.kt)("p",null,"To test it out run "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"npm run dev\n")),(0,o.kt)("p",null,"and navigate to the specified url (eg. ",(0,o.kt)("inlineCode",{parentName:"p"},"http://localhost:3000/"),");"),(0,o.kt)("p",null,"then connect your wallet."),(0,o.kt)("p",null,"and click on the ",(0,o.kt)("inlineCode",{parentName:"p"},"Lock 10 tADA")," button."),(0,o.kt)("p",null,"If everything works correctly you should be prompted to sign a transaciton."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"sing transaciton pop-up",src:n(7970).Z,width:"1312",height:"645"})),(0,o.kt)("h2",{id:"unlock-the-funds"},"Unlock the funds"),(0,o.kt)("p",null,"Now that the smart contract has something to spend we can really test it out."),(0,o.kt)("p",null,"In fact, our smart contract never ran so far."),(0,o.kt)("p",null,'That is because Cardano smart contracts only run if funds needs to be spent (some call them "Spending Validators").'),(0,o.kt)("p",null,"So now we are going to do exactly that, we are going to spend some (our) smart contract funds."),(0,o.kt)("p",null,"the starting point is similar to before."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/offchain/getUnlockTx.ts"',title:'"src/offchain/getUnlockTx.ts"'},"async function getUnlockTx( wallet: BrowserWallet ): Promise<Tx>\n{\n    throw \"'unlockTx' logic not implemented\";   \n}\n")),(0,o.kt)("h3",{id:"txbuilder-and-myutxos"},(0,o.kt)("inlineCode",{parentName:"h3"},"txBuilder")," and ",(0,o.kt)("inlineCode",{parentName:"h3"},"myUTxOs")),(0,o.kt)("p",null,"transaciton builder and utxos for the treansaction."),(0,o.kt)("p",null,"The steps are the same:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const txBuilder = await getTxBuilder();\nconst myUTxOs = (await wallet.getUtxos()).map( toPlutsUtxo );\n")),(0,o.kt)("h3",{id:"myaddrs-and-myaddr"},(0,o.kt)("inlineCode",{parentName:"h3"},"myAddrs")," and ",(0,o.kt)("inlineCode",{parentName:"h3"},"myAddr")),(0,o.kt)("p",null,"Before we got the user address by calling ",(0,o.kt)("inlineCode",{parentName:"p"},"wallet.getChangeAddress"),"."),(0,o.kt)("p",null,"This returns a single address of the contract. But wallet might have many;\nand from the moment that we are not really sure of which one we'll get, this time we'll select it manually."),(0,o.kt)("p",null,"to get all the address of a wallet we can call"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"await wallet.getUsedAddresses()\n")),(0,o.kt)("p",null,"just like before the method returns strings; so we'll need to call ",(0,o.kt)("inlineCode",{parentName:"p"},"Address.fromString")," for each of them."),(0,o.kt)("p",null,"This way we can get all the wallet addresses as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const myAddrs = (await wallet.getUsedAddresses()).map( Address.fromString );\n")),(0,o.kt)("p",null,"from these we'll decide which one will be used in the next step."),(0,o.kt)("p",null,"For now lets just decalre a variable for it."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"let myAddr!: Address;\n")),(0,o.kt)("h3",{id:"get-the-scripts-utxos"},"get the script's utxos"),(0,o.kt)("p",null,"Script utxos are a bit trickier... scripts don't have wallets!"),(0,o.kt)("p",null,"So to retreive the script's utxos we'll rely on koios; the code to query them is:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"await koios.address.utxos( scriptTestnetAddr )\n")),(0,o.kt)("p",null,"where ",(0,o.kt)("inlineCode",{parentName:"p"},"scriptTestnetAddr")," is imported from ",(0,o.kt)("inlineCode",{parentName:"p"},"contracts/helloPluts.ts"),"."),(0,o.kt)("p",null,"but a script might (and will) have multiple utxos... how do we know which one is our?"),(0,o.kt)("p",null,"for that we'll search between them using the following funciton"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const utxoToSpend = (await koios.address.utxos( scriptTestnetAddr ))\n.find( utxo => {\n    const datum = utxo.resolved.datum;\n\n    if(\n        // datum is inline\n        isData( datum ) &&\n        // and is only bytes\n        datum instanceof DataB\n    )\n    {\n        const pkh = datum.bytes.toBuffer();\n\n        // search if it corresponds to one of my public keys\n        const myPkhIdx = myAddrs.findIndex(\n            addr => uint8ArrayEq( pkh, addr.paymentCreds.hash.toBuffer() )\n        );\n\n        // not a pkh of mine; not an utxo I can unlock\n        if( myPkhIdx < 0 ) return false;\n\n        // else found my locked utxo\n        myAddr = myAddrs[ myPkhIdx ];\n\n        return true;\n    }\n\n    return false;\n});\n")),(0,o.kt)("p",null,"given an utxo we first need to check that it has an inline datum and that the datum is just made of bytes."),(0,o.kt)("p",null,"once we know the datum is in the correct format we extract the setted public key hash that represents that utxo owner:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const pkh = datum.bytes.toBuffer();\n")),(0,o.kt)("p",null,"and finally we check for the owner to be equal to any of the addresses in control of the wallet;\nif any address matches the we found the address to be used and the utxo to be spent; otherwise we check an other utxo."),(0,o.kt)("p",null,"after the filter call ",(0,o.kt)("inlineCode",{parentName:"p"},"myAddr")," will then be defined."),(0,o.kt)("h3",{id:"build-the-transaciton"},"build the transaciton"),(0,o.kt)("p",null,"now we have everything needed; we can build the unlocking transaciton:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'txBuilder.buildSync({\n    inputs: [\n        {\n            utxo: utxoToSpend as any,\n            // we must include the utxo that holds our script\n            inputScript: {\n                script,\n                datum: "inline", // the datum is present already on `utxoToSpend`\n                redeemer: new DataB( fromAscii("Hello plu-ts") ) // be polite\n            }\n        }\n    ],\n    requiredSigners: [ myAddr.paymentCreds.hash ],\n    // make sure to include collateral when using contracts\n    collaterals: [ myUTxOs[0] ],\n    // send everything back to us\n    changeAddress: myAddr\n});\n')),(0,o.kt)("p",null,"this time the transaciton is a bit more complicated so let's check what's new."),(0,o.kt)("p",null,"First of all the input now comes from a script! For this reason we have to include the script in alongside the utxo to be spent for the script to validate it."),(0,o.kt)("p",null,"this is done trough the ",(0,o.kt)("inlineCode",{parentName:"p"},"inputScript")," option:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'inputScript: {\n    script,\n    datum: "inline", // the datum is present already on `utxoToSpend`\n    redeemer: new DataB( fromAscii("Hello plu-ts") ) // be polite\n}\n')),(0,o.kt)("p",null,"the ",(0,o.kt)("inlineCode",{parentName:"p"},"script")," is the one imported from ",(0,o.kt)("inlineCode",{parentName:"p"},"contracts/helloPluts.ts"),"."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"datum")," is set to be ",(0,o.kt)("inlineCode",{parentName:"p"},'"inline"')," which means that the datum is already present on the UTxO being spent."),(0,o.kt)("p",null,"finally ",(0,o.kt)("inlineCode",{parentName:"p"},"redeemer")," is used to pass the redeemer to call the contract with."),(0,o.kt)("admonition",{title:"redeemer",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"unlike the datum, the redeemer is used to pass data to the script at the moment of calling it."),(0,o.kt)("p",{parentName:"admonition"},"this can be used as a way to comunicate between the user and the contract")),(0,o.kt)("p",null,"The onther important part of the tranasaction is the ",(0,o.kt)("inlineCode",{parentName:"p"},"requiredSigners")," option."),(0,o.kt)("p",null,"Here we have to specify the our public key hash so that it can be included int the ",(0,o.kt)("inlineCode",{parentName:"p"},"signatories")," field of the context passed to the contract.\nIf we forget it the ",(0,o.kt)("inlineCode",{parentName:"p"},"ctx.tx.signatories")," value in our smart contract will be empty!"),(0,o.kt)("p",null,"and finally, the third news is the ",(0,o.kt)("inlineCode",{parentName:"p"},"collaterals")," option; this can be any utxo we own as long as it contains only ADA;\nif it includes any other token it must be returned using the ",(0,o.kt)("inlineCode",{parentName:"p"},"collateralReturn")," option; but this is not our case."),(0,o.kt)("p",null,"So our final ",(0,o.kt)("inlineCode",{parentName:"p"},"getUnlockTx")," funciton looks like this."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="src/offchain/getUnlockTx.ts"',title:'"src/offchain/getUnlockTx.ts"'},'async function getUnlockTx( wallet: BrowserWallet ): Promise<Tx>\n{\n    const myAddrs = (await wallet.getUsedAddresses()).map( Address.fromString );\n    \n    const txBuilder = await getTxBuilder();\n    const myUTxOs = (await wallet.getUtxos()).map( toPlutsUtxo );\n\n    /**\n     * Wallets migh have multiple addresses;\n     * \n     * to understand which one we previously used to lock founds\n     * we\'ll get the address based on the utxo that keeps one of ours\n     * public key hash as datum\n    **/\n    let myAddr!: Address;\n\n    // only the onses with valid datum\n    const utxoToSpend = (await koios.address.utxos( scriptTestnetAddr ))\n    .find( utxo => {\n        const datum = utxo.resolved.datum;\n\n        if(\n            // datum is inline\n            isData( datum ) &&\n            // and is only bytes\n            datum instanceof DataB\n        )\n        {\n            const pkh = datum.bytes.toBuffer();\n\n            // search if it corresponds to one of my public keys\n            const myPkhIdx = myAddrs.findIndex(\n                addr => uint8ArrayEq( pkh, addr.paymentCreds.hash.toBuffer() )\n            );\n\n            // not a pkh of mine; not an utxo I can unlock\n            if( myPkhIdx < 0 ) return false;\n\n            // else found my locked utxo\n            myAddr = myAddrs[ myPkhIdx ];\n\n            return true;\n        }\n\n        return false;\n    });\n\n    if( utxoToSpend === undefined )\n    {\n        throw "uopsie, are you sure your tx had enough time to get to the blockchain?"\n    }\n\n    return txBuilder.buildSync({\n        inputs: [\n            {\n                utxo: utxoToSpend as any,\n                // we must include the utxo that holds our script\n                inputScript: {\n                    script,\n                    datum: "inline", // the datum is present already on `utxoToSpend`\n                    redeemer: new DataB( fromAscii("Hello plu-ts") ) // be polite\n                }\n            }\n        ],\n        requiredSigners: [ myAddr.paymentCreds.hash ],\n        // make sure to include collateral when using contracts\n        collaterals: [ myUTxOs[0] ],\n        // send everything back to us\n        changeAddress: myAddr\n    });\n}\n')),(0,o.kt)("h3",{id:"test-the-contract"},"test the contract"),(0,o.kt)("p",null,"Now our applicaiton is complete."),(0,o.kt)("p",null,"We just need to test out the last feature introduced."),(0,o.kt)("p",null,"once again spin up the web page and this time let's click on the second button."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"unlock tx pop-up",src:n(4881).Z,width:"1312",height:"645"})),(0,o.kt)("admonition",{title:"smart contract determinism",type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"did you know that smart contract on cardano are deterministic?"),(0,o.kt)("p",{parentName:"admonition"},"it means that when you run them with the same inputs you always get the same output."),(0,o.kt)("p",{parentName:"admonition"},"For this reason the plu-ts ",(0,o.kt)("inlineCode",{parentName:"p"},"TxBuilder")," is able to pre-evaluate your transaciton\nand will throw an error if the script fails!"),(0,o.kt)("p",{parentName:"admonition"},"that means that if you are signing a transaciton built wit plu-ts you can be sure there are no surprises!")),(0,o.kt)("p",null,"here is an example of suceeding transaciton:"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://preprod.cardanoscan.io/transaction/3d04a8bb90c3d6edb765439f3ec370053b2904841648ba64281c0680a73226fa"},"https://preprod.cardanoscan.io/transaction/3d04a8bb90c3d6edb765439f3ec370053b2904841648ba64281c0680a73226fa")))}p.isMDXComponent=!0},7970:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/sign_lock_hello_world-0f9426fd1c6ee038f2026004508f9647.gif"},4881:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/sign_unlock_hello_world-2f63bc751cf67e198a7d71af1ee795fc.gif"}}]);